<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>ğŸ—³ï¸ DApp Bá» Phiáº¿u Blockchain</title>

<style>
* {
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f3f4f6;
  padding: 30px;
}

h1 {
  text-align: center;
  margin-bottom: 30px;
}

.container {
  max-width: 1200px;
  margin: auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 20px;
}

.card {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

.wallet-card {
  grid-column: span 2;
}

h3 {
  margin-top: 0;
}

button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.primary { background: #4f46e5; color: #fff; }
.success { background: #16a34a; color: #fff; }
.warning { background: #f59e0b; color: #fff; }
.info { background: #0ea5e9; color: #fff; }
.danger { background: #dc2626; color: #fff; }
.gray { background: #6b7280; color: #fff; }

input, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-family: monospace;
  font-size: 13px;
}

.candidate {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 12px;
  margin-top: 10px;
}

#status {
  margin-top: 25px;
  padding: 16px;
  background: #111827;
  color: #fff;
  border-radius: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<h1>ğŸ—³ï¸ á»¨ng dá»¥ng Bá» Phiáº¿u Blockchain (Sepolia)</h1>

<div class="container">

<!-- WALLET -->
<div class="card wallet-card">
  <h3>ğŸ”Œ Káº¿t ná»‘i vÃ­</h3>

  <button class="primary" onclick="connectWallet()">Káº¿t ná»‘i MetaMask</button>
  <button class="danger" onclick="disconnectWallet()">Ngáº¯t káº¿t ná»‘i</button>

  <label>Chá»n tÃ i khoáº£n:</label>
  <select id="accountSelect" onchange="changeAccount()"></select>
</div>

<!-- CONTRACT -->
<div class="card wallet-card">
  <h3>ğŸ“œ Smart Contract</h3>

  <label>Äá»‹a chá»‰ Contract:</label>
  <input id="contractInput" placeholder="0x..." />

  <button class="info" onclick="applyContract()">Ãp dá»¥ng Contract</button>
  <button class="gray" onclick="openEtherscan()">ğŸ” Xem trÃªn Etherscan</button>
</div>

<!-- ADMIN -->
<div class="card">
  <h3>ğŸ‘¤ Quáº£n lÃ½ báº§u cá»­</h3>
  <button class="warning" onclick="addCandidate()">â• ThÃªm á»©ng viÃªn</button>
</div>

<!-- VOTING -->
<div class="card">
  <h3>ğŸ—³ï¸ Danh sÃ¡ch á»©ng viÃªn</h3>
  <button class="info" onclick="loadCandidates()">ğŸ”„ Táº£i danh sÃ¡ch</button>
  <div id="candidateList"></div>
</div>

<!-- QUERY -->
<div class="card">
  <h3>ğŸ“Š Tra cá»©u thÃ´ng tin bá» phiáº¿u</h3>

  <button class="info" onclick="loadElectionInfo()">ğŸ” Xem thÃ´ng tin bá» phiáº¿u</button>
  <button class="info" onclick="checkMyVoteStatus()">ğŸ‘¤ Kiá»ƒm tra tÃ´i Ä‘Ã£ bá» phiáº¿u chÆ°a</button>

  <div id="electionInfo" style="margin-top:12px;font-size:14px;"></div>
</div>

</div>

<div id="status">â³ Sáºµn sÃ ng</div>

<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";

let provider, signer, contract;
let CONTRACT_ADDRESS = null;
let accounts = [];

const ABI = [
  { "inputs": [], "name": "addCandidate", "outputs": [], "type": "function" },
  { "inputs": [{"type":"uint256","name":"candidateId"}], "name": "vote", "outputs": [], "type": "function" },
  {
    "inputs":[{"type":"uint256","name":"id"}],
    "name":"getCandidate",
    "outputs":[{"type":"uint256","name":"id"},{"type":"uint256","name":"voteCount"}],
    "stateMutability":"view",
    "type":"function"
  },
  { "inputs": [], "name": "candidateCount", "outputs": [{"type":"uint256"}], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "electionOfficial", "outputs": [{"type":"address"}], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "startTime", "outputs": [{"type":"uint256"}], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "endTime", "outputs": [{"type":"uint256"}], "stateMutability": "view", "type": "function" },
  { "inputs": [{"type":"address"}], "name": "hasVoted", "outputs": [{"type":"bool"}], "stateMutability": "view", "type": "function" }
];

const setStatus = msg =>
  document.getElementById("status").innerText = msg;

async function switchToSepolia() {
  await ethereum.request({
    method: "wallet_switchEthereumChain",
    params: [{ chainId: "0xaa36a7" }]
  });
}

/* ===== WALLET ===== */
window.connectWallet = async () => {
  await ethereum.request({ method: "eth_requestAccounts" });
  await switchToSepolia();

  provider = new ethers.BrowserProvider(window.ethereum);
  accounts = await provider.send("eth_accounts", []);

  const select = document.getElementById("accountSelect");
  select.innerHTML = "";
  accounts.forEach(a => {
    const o = document.createElement("option");
    o.value = a;
    o.textContent = a;
    select.appendChild(o);
  });

  signer = await provider.getSigner(accounts[0]);
  setStatus("âœ… ÄÃ£ káº¿t ná»‘i MetaMask");
};

window.changeAccount = async () => {
  signer = await provider.getSigner(
    document.getElementById("accountSelect").value
  );
  if (CONTRACT_ADDRESS)
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  setStatus("ğŸ”„ ÄÃ£ Ä‘á»•i tÃ i khoáº£n");
};

window.disconnectWallet = () => {
  provider = signer = contract = null;
  CONTRACT_ADDRESS = null;
  document.getElementById("candidateList").innerHTML = "";
  document.getElementById("electionInfo").innerHTML = "";
  setStatus("ğŸ”Œ ÄÃ£ ngáº¯t káº¿t ná»‘i");
};

/* ===== CONTRACT ===== */
window.applyContract = () => {
  const addr = document.getElementById("contractInput").value.trim();
  if (!ethers.isAddress(addr)) return alert("Äá»‹a chá»‰ contract khÃ´ng há»£p lá»‡");
  if (!signer) return alert("ChÆ°a káº¿t ná»‘i vÃ­");

  CONTRACT_ADDRESS = addr;
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  setStatus("ğŸ“œ ÄÃ£ Ã¡p dá»¥ng contract");
};

window.openEtherscan = () => {
  if (!CONTRACT_ADDRESS) return alert("ChÆ°a cÃ³ Ä‘á»‹a chá»‰ contract");
  window.open(
    `https://sepolia.etherscan.io/address/${CONTRACT_ADDRESS}`,
    "_blank"
  );
};

/* ===== CANDIDATES ===== */
window.loadCandidates = async () => {
  if (!contract) return alert("ChÆ°a Ã¡p dá»¥ng contract");

  const list = document.getElementById("candidateList");
  list.innerHTML = "";

  const count = await contract.candidateCount();

  for (let i = 1; i <= count; i++) {
    const c = await contract.getCandidate(i);

    const div = document.createElement("div");
    div.className = "candidate";
    div.innerHTML = `
      <b>á»¨ng viÃªn #${c.id}</b><br>
      ğŸ—³ï¸ Sá»‘ phiáº¿u: ${c.voteCount}
      <button class="success" onclick="vote(${c.id})">Bá» phiáº¿u</button>
    `;
    list.appendChild(div);
  }

  setStatus("ğŸ“Š ÄÃ£ táº£i danh sÃ¡ch á»©ng viÃªn");
};

window.vote = async (id) => {
  try {
    setStatus("â³ Äang bá» phiáº¿u...");
    const tx = await contract.vote(id);
    await tx.wait();
    setStatus("âœ… Bá» phiáº¿u thÃ nh cÃ´ng");
    await loadCandidates();
  } catch {
    setStatus("âŒ KhÃ´ng thá»ƒ bá» phiáº¿u");
  }
};

window.addCandidate = async () => {
  try {
    setStatus("â³ Äang thÃªm á»©ng viÃªn...");
    const tx = await contract.addCandidate();
    await tx.wait();
    setStatus("âœ… ÄÃ£ thÃªm á»©ng viÃªn");
    await loadCandidates();
  } catch {
    setStatus("âŒ Chá»‰ quáº£n trá»‹ viÃªn má»›i Ä‘Æ°á»£c thÃªm");
  }
};

function formatTimeGMT7(timestamp) {
  const date = new Date((timestamp ) * 1000);

  const pad = n => n.toString().padStart(2, "0");

  return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()}, ` +
         `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())} (GMT+7)`;
}

/* ===== QUERY ===== */
window.loadElectionInfo = async () => {
  if (!contract) return alert("ChÆ°a Ã¡p dá»¥ng contract");

  const official = await contract.electionOfficial();
  const start = Number(await contract.startTime());
  const end = Number(await contract.endTime());
  const count = await contract.candidateCount();
  const now = Math.floor(Date.now() / 1000);

  let status = "â³ ChÆ°a báº¯t Ä‘áº§u";
  if (now >= start && now <= end) status = "ğŸŸ¢ Äang diá»…n ra";
  if (now > end) status = "ğŸ”´ ÄÃ£ káº¿t thÃºc";

  const remaining =
    now < end ? Math.floor((end - now) / 60) + " phÃºt" : "0";

  document.getElementById("electionInfo").innerHTML = `
    <b>ğŸ‘¤ NgÆ°á»i quáº£n lÃ½:</b><br>${official}<br><br>

    <b>ğŸ•’ Thá»i gian báº¯t Ä‘áº§u:</b><br>
    ${formatTimeGMT7(start)}<br><br>

    <b>ğŸ•” Thá»i gian káº¿t thÃºc:</b><br>
    ${formatTimeGMT7(end)}<br><br>

    <b>ğŸ“Œ Tráº¡ng thÃ¡i:</b> ${status}<br>
    <b>â³ Thá»i gian cÃ²n láº¡i:</b> ${remaining}<br><br>

    <b>ğŸ‘¥ Tá»•ng sá»‘ á»©ng viÃªn:</b> ${count}
  `;
};

window.checkMyVoteStatus = async () => {
  if (!contract || !signer) return;

  const addr = await signer.getAddress();
  const voted = await contract.hasVoted(addr);

  document.getElementById("electionInfo").innerHTML =
    voted ? "âœ… VÃ­ nÃ y Ä‘Ã£ bá» phiáº¿u" : "âŒ VÃ­ nÃ y chÆ°a bá» phiáº¿u";
};
</script>

</body>
</html>

